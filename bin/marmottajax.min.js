var marmottajax=function(){var t=function(t,e){for(var s=t.length;s--;)if(t[s]===e)return!0;return!1},e=function(t,e){for(var s in e)t[s]=e[s]},s=function(t,e){var r,i=[];for(r in t)if(t.hasOwnProperty(r)){var n=t[r],a="object"==typeof n,h=e?e+"["+(isNaN(+r)||a?r:"")+"]":r;i.push(a?s(n,h):encodeURIComponent(h)+"="+encodeURIComponent(n))}return i.join("&")},r=function(t){return t instanceof HTMLElement},i=function(t,e){for(var s in t)t.hasOwnProperty(s)&&e(t[s])},n=function(t){if(this.self)return new n(arguments);var r,a,h=this,o=!0,c=n.normalize(t);if(null===c)throw"Invalid arguments";if(e(h,c),h.where)return i(h.where.querySelectorAll(".marmottajax"),function(t){t.onsubmit=function(e){e.preventDefault(),c={url:t.action,formpassed:!0,parameters:t,success:h.success,error:h.error},new n(c)}});c=c.parameters;for(r in h.parameters)o=!1;if(h.is_html){var l=c.matches('input[type="file"]');if(!l&&!h.is_form)throw"Invalid form";h.method="post",h.isform=!0,h.url||(h.url=c.action),a=new FormData(c),l&&a.append(c.name||"file",c.files[0]),h.postData=a}else"GET"!=h.method.toUpperCase()?h.postData=s(h.parameters):h.url+=("?"==h.url.slice(-1)||o?"":"?")+s(h.parameters);h.setXhr(),h.setWatcher()};return n.defaults={method:"get",json:!1,watch:-1,parameters:{},headers:{},success:function(){},error:function(){}},n.validMethods=["get","post","put","update","delete"],n.okStatusCodes=[200,201,202,203,204,205,206],n.normalize=function(e){if("object"!=typeof e)return null;e=e[0]||e;var s,i,a=e.parameters,h={url:"string"==typeof e?e:e.url},o={json:"string",watch:"number",parameters:"object",headers:"object",success:"function",error:"function"};r(a)?(h.is_html=!0,h.is_form=a.matches("form")):r(e)&&(e={parameters:e}),h.where=e.ajax_forms_in,s="string"==typeof e.method?e.method.toLowerCase():0,s=t(n.validMethods,s)?s:n.defaults.method,h.method=s;for(i in o)h[i]=typeof e[i]==o[i]?e[i]:n.defaults[i];return h},n.prototype.setWatcher=function(){-1!==this.watch&&(this.watchIntervalFunction=function(){4===this.xhr.readyState&&t(n.okStatusCodes,this.xhr.status)&&this.updateXhr(),this.watcherTimeout()},this.watcherTimeout(),this.stop=function(){this.changeTime(-1)},this.changeTime=function(t){clearTimeout(this.changeTimeout),this.watch="number"==typeof t?t:this.watch,this.watcherTimeout()})},n.prototype.setXhr=function(){var e=this;this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.lastResult=null,this.xhr.json=this.json,this.xhr.binding=null,this.bind=function(t){return this.xhr.binding=t,this},this.cancel=function(t){return this.xhr.abort(),this},this.xhr.callbacks={then:[],change:[],error:[]};for(var s in this.xhr.callbacks)this.xhr.callbacks.hasOwnProperty(s)&&(this[s]=function(t){return function(e){return this.xhr.callbacks[t].push(e),this}}(s));this.xhr.call=function(t,e){for(var s=0;s<this.callbacks[t].length;s++)"function"==typeof this.callbacks[t][s]&&(this.binding?this.callbacks[t][s].call(this.binding,e):this.callbacks[t][s](e))},this.xhr.onreadystatechange=function(){if(4===this.readyState&&t(n.okStatusCodes,this.status)){var s=this.responseText;if(this.json)try{s=JSON.parse(s)}catch(r){return this.call("error","invalid json"),e.error("invalid json"),!1}this.lastResult=s,this.call("then",s),e.success(s)}else 4===this.readyState&&404==this.status?(this.call("error","404"),e.error("unknown error")):4===this.readyState&&(this.call("error","unknown"),e.error("unknown error"))},this.xhr.open(this.method,this.url,!0),this.isform||this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(header in this.headers)this.headers.hasOwnProperty(header)&&this.xhr.setRequestHeader(header,this.headers[header]);this.xhr.send(this.postData?this.postData:null)},n.prototype.updateXhr=function(){var e={lastResult:this.xhr.lastResult,json:this.xhr.json,binding:this.xhr.binding,callbacks:{then:this.xhr.callbacks.then,change:this.xhr.callbacks.change,error:this.xhr.callbacks.error}};this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.lastResult=e.lastResult,this.xhr.json=e.json,this.xhr.binding=e.binding,this.xhr.callbacks={then:e.callbacks.then,change:e.callbacks.change,error:e.callbacks.error},this.xhr.call=function(t,e){for(var s=0;s<this.callbacks[t].length;s++)"function"==typeof this.callbacks[t][s]&&(this.binding?this.callbacks[t][s].call(this.binding,e):this.callbacks[t][s](e))},this.xhr.onreadystatechange=function(){if(4===this.readyState&&t(n.okStatusCodes,this.status)){var e=this.responseText;if(this.json)try{e=JSON.parse(e)}catch(s){return this.call("error","invalid json"),!1}isDifferent=this.lastResult!=e;try{isDifferent=("string"!=typeof this.lastResult?JSON.stringify(this.lastResult):this.lastResult)!=("string"!=typeof e?JSON.stringify(e):e)}catch(s){}isDifferent&&this.call("change",e),this.lastResult=e}else 4===this.readyState&&404==this.status?this.call("error","404"):4===this.readyState&&this.call("error","unknow")},this.xhr.open(this.method,this.url,!0),this.isform||this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xhr.send(this.postData?this.postData:null)},n.prototype.watcherTimeout=function(){-1!==this.watch&&(this.changeTimeout=setTimeout(function(t){return function(){t.watchIntervalFunction()}}(this),this.watch))},n}();